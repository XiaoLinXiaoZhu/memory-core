## 存在的问题
目前仍然存在部分问题，集中在以下几点：

### 1. ai尝试获取非常长的内容

有的时候ai会尝试将 expend 设置为 4、5 甚至更高的值，导致很多文件被展开，mcp返回一个非常大的文件，出现这种情况，应当主动限制最大文本长度为 2k，当长度超过这个值时，应当提醒模型尝试减少展开层次，并且尝试手动获取细节内容


### 2. extractContent 还是不够灵活

extractContent 目前仍然存在比较大的匹配的问题，尤其是当ai尝试使用行号而不适用regex时，容易出现两个问题：对于长的文本难以计算行号；编辑后行号更新，但是没有同步

解决方法： getContent 增加一个包含行号的功能，默认为false，启用后，将会输出：
```
1 |第一行内容
2 |第二行内容
3 |第三行内容
```

这样的模式，为ai提供更好的行号支持

并且修改 extractContent 的相关提示词，以保证ai在每次使用后都再次获取最新的内容

### 3. 文件保护

增加文件保护功能，当进行编辑操作时，强制要求模型已经获取了最新的内容或者是刚刚对该文件进行了编辑，如果没有获取最新内容，则不允许进行编辑操作。

判断为已经获取文件内容的标准有五个：
1. 使用 getContent 获取最新内容
2. 使用 getContent 时，如果也同时展开了该其下面链接的文件，那么也算作是获取了链接了的文件的最新内容
3. 使用 setContent 进行编辑过了，那么最新的编辑内容就是最新内容
4. 使用 extractContent 时，将内容提取出来了，那么提取的目标文件也算作是获取了最新内容
5. 不存在该文件，或者该文件存在 EMPTY_PLACEHOLDER 标记的文件，视为就是最新内容（因为不存在内容）

属于编辑操作，需要校验是否获取最新内容的操作有：
1. setContent 的编辑操作
2. extractContent 的源文件
3. insertLinkAt 的插入目标
4. renameFile 的重命名目标

进行以下操作后，将会被移除已经获取最新内容的标记：
1. extractContent 的源文件
2. insertLinkAt 的插入目标
3. renameFile 的重命名目标

### 4. 防止重复获取内容

有的时候，模型会重复获取同一个文件的内容，导致不必要的性能消耗。可以通过以下方式优化：

在 3. 中 已经判断为获取了最新内容的操作中，增加一个标记，表示该文件已经获取了最新内容。
在进行 getContent 时，检查该文件是否已经获取了最新内容，如果是，则提示模型该文件在上下文中已经存在最新内容，无需再次获取。


## 开发建议
### memory-core 需要修改：

1. 增加 getContent 的行号输出功能


### memory-server 需要修改：
1. 增加对 getContent 的行号输出功能的支持
2. 增加 getContent 最大文本长度限制为 2k，超过则截断后续部分，提示模型尝试减少展开层次，并手动获取细节内容（该次不计入获取最新内容的标记）
3. 增加对文件保护的支持
4. 增加对防止重复获取内容的支持
5. 修改 extractContent 的提示词，提示每次修改前都需要获取最新内容